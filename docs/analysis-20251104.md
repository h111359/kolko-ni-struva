# Repository Analysis – 2025-11-04

## Overview
Comprehensive audit of the `kolko-ni-struva` repository focusing on inconsistencies, best practices, and errors. Excludes `logs/` entirely; `data/raw/` only sampled (currently empty).

---

## 1. Inconsistencies

### 1.1 Shebang Variations
- **scripts/refresh.sh**: `#!/bin/bash`
- **scripts/run-site.sh**: `#!/bin/bash`  
- **.specify/scripts/bash/*.sh**: `#!/usr/bin/env bash`

**Rationale**: Mixed shebang styles reduce consistency. `#!/usr/bin/env bash` is more portable across systems where bash may not be at `/bin/bash`.

### 1.2 Script Permissions
- **common.sh**: Not executable (`-rw-rw-r--`)
- **All other .sh files**: Executable (`-rwxrwxr-x`)

**Rationale**: `common.sh` is sourced, not executed directly, but inconsistent permissions can confuse developers.

### 1.3 Missing Python Source Code
- **Referenced in scripts/refresh.sh**:
  - `src/py/kolko-ni-struva/etl/download_kolkonistruva.py` – MISSING
  - `src/py/kolko-ni-struva/etl/update_kolko_ni_struva.py` – MISSING
- **Directory**: `src/py/` does not exist

**Rationale**: Core ETL scripts are referenced but absent. Project cannot function as documented.

### 1.4 Missing Referenced Script
- **netlify.toml** references: `bash scripts/build.sh`
- **File**: `scripts/build.sh` – MISSING

**Rationale**: Deployment configuration points to non-existent script, breaking Netlify builds.

### 1.5 HTML Asset Paths
- **index.html** references: `style.css`, `script.js` (root-relative paths)
- **Actual locations**: `src/web/assets/style.css`, `src/web/js/script.js`

**Rationale**: Mismatch between source and deployed structure. Only works if build process copies files correctly to `build/web/`.

### 1.6 Documentation vs. Reality
- **docs/developer-guides/file-structure.md** describes:
  - `src/py/kolko-ni-struva/` with ETL modules, CLI, schemas
  - `scripts/build.sh`, `scripts/build.ps1`, `scripts/test.sh`, `scripts/test.ps1`, `scripts/deploy.sh`, `scripts/deploy.ps1`
- **Reality**: None of these exist except directory structure

**Rationale**: Documentation is aspirational, not reflective of current state.

---

## 2. Best Practice Recommendations

### 2.1 Portability Strategy

#### Current State: Bash-First, Linux-Centric
- Scripts use GNU `date -d` (line 200-201 in refresh.sh) – fails on macOS/BSD
- No PowerShell equivalents despite documentation claims

#### Recommended Approach: Python Entrypoints
1. **Create Python CLI** (`src/py/kolko-ni-struva/cli.py`):
   - Commands: `download`, `update`, `build`, `test`, `deploy`
   - Cross-platform date handling via `datetime` module
   - Use `pathlib` for cross-platform paths
   - Entry point in `pyproject.toml` already defined: `kolko-ni-struva = "kolko-ni-struva.cli:main"`

2. **Thin Shell Wrappers**:
   ```bash
   #!/usr/bin/env bash
   python -m kolko-ni-struva.cli refresh
   ```
   ```powershell
   # refresh.ps1
   python -m kolko-ni-struva.cli refresh
   ```

3. **Environment Handling**:
   - Use `python-dotenv` to load `.env` files
   - Validate required variables at startup
   - Document all env vars in `.env.example`

#### Quick Wins
- Replace `date -d "yesterday"` with:
  ```bash
  python -c "from datetime import datetime, timedelta; print((datetime.now() - timedelta(1)).strftime('%Y-%m-%d'))"
  ```
- Replace `stat -f%z || stat -c%s` with:
  ```bash
  python -c "import os; print(os.path.getsize('build/web/data.csv'))"
  ```

### 2.2 Repository Layout
- **✓ Good**: Separation of `src/`, `data/`, `build/`, `docs/`, `tests/`
- **✓ Good**: `.gitignore` excludes generated artifacts
- **Action**: Create missing directories:
  - `src/py/kolko-ni-struva/etl/`
  - `src/py/kolko-ni-struva/schemas/`
  - `data/raw/`, `data/interim/`, `data/processed/`
  - `build/web/` (script creates it, but pre-create in repo with README)

### 2.3 CI/CD
- **Missing**: `.github/workflows/` directory
- **Recommendation**: Add workflows for:
  - **ci.yml**: Lint (shellcheck, black, flake8), test (pytest), build validation
  - **deploy.yml**: Automated Netlify deployment on main branch
  - **scheduled.yml**: Daily data refresh job

### 2.4 Testing
- **Current**: Empty `tests/` (only `fixtures/sample_data/README.md`)
- **Recommendation**:
  - Add `tests/test_etl.py`, `tests/test_cli.py`, `tests/test_web.py`
  - Use `pytest` fixtures for test data
  - Add `tests/tmp/` to `.gitignore` (already present)
  - CI should run tests on every PR

### 2.5 Linting & Formatting
- **Configured but Not Enforced**:
  - `pyproject.toml` specifies `black`, `flake8`, `pytest`
  - No pre-commit hooks
  - No CI enforcement

- **Actions**:
  - Add `.pre-commit-config.yaml`:
    ```yaml
    repos:
      - repo: https://github.com/psf/black
        rev: 24.1.0
        hooks:
          - id: black
      - repo: https://github.com/pycqa/flake8
        rev: 7.0.0
        hooks:
          - id: flake8
      - repo: https://github.com/koalaman/shellcheck-precommit
        rev: v0.9.0
        hooks:
          - id: shellcheck
    ```
  - Run `pre-commit install` in setup docs

### 2.6 Secrets Handling
- **✓ Good**: `.env.example` provided, `.env` gitignored
- **✓ Good**: No hardcoded secrets found in code
- **Action**: Document sensitive variables:
  - `NETLIFY_AUTH_TOKEN` usage and scope
  - Where/how to obtain tokens
  - Rotation policy

### 2.7 Documentation
- **✓ Good**: Structured docs under `docs/`
- **Gap**: No API documentation for Python modules (once created)
- **Gap**: No changelog maintenance (empty `docs/changes/`)
- **Actions**:
  - Use docstrings in Python code (Google or NumPy style)
  - Generate API docs with Sphinx or mkdocs
  - Maintain `CHANGELOG.md` for version history
  - Add examples in `docs/user-guides/`

### 2.8 Versioning & Releases
- **Current**: Version `0.1.0` in `pyproject.toml`, no git tags
- **Recommendation**:
  - Adopt semantic versioning (SemVer)
  - Tag releases: `git tag v0.1.0`
  - Automate versioning with `bump2version` or `poetry`
  - Include version in web UI footer

### 2.9 Build Artifacts
- **✓ Good**: `build/` in `.gitignore`
- **Gap**: No documentation on what `build/web/` should contain
- **Action**: Add `build/web/README.md` explaining:
  - Auto-generated by `refresh.sh` or `build.sh`
  - Contains: `index.html`, `style.css`, `script.js`, `data.csv`, `data/dims/`, `data/facts/`
  - Never commit to git

---

## 3. Errors

### 3.1 Broken References
1. **netlify.toml:3** → `bash scripts/build.sh` – file does not exist
   - **Fix**: Create `scripts/build.sh` or update netlify.toml to use `scripts/refresh.sh`

2. **scripts/refresh.sh:132-140** → Python scripts do not exist
   - **Fix**: Implement `src/py/kolko-ni-struva/etl/download_kolkonistruva.py`
   - **Fix**: Implement `src/py/kolko-ni-struva/etl/update_kolko_ni_struva.py`

3. **README.md:100** → `python -m kolko-ni-struva.cli` – module does not exist
   - **Fix**: Create `src/py/kolko-ni-struva/cli.py`

### 3.2 Portability Bugs in refresh.sh

#### Line 52: Unchecked `cd`
```bash
cd "$(dirname "$0")/.."  # SC2164: Should use 'cd ... || exit'
```
**Fix**: `cd "$(dirname "$0")/.." || exit 1`

#### Lines 200-201: GNU date (Linux-only)
```bash
YESTERDAY=$(date -d "yesterday" +%Y-%m-%d)    # Fails on macOS
T2DAYS=$(date -d "2 days ago" +%Y-%m-%d)      # BSD date uses -v
```
**Fix**: Use Python or add platform detection:
```bash
if date -v-1d >/dev/null 2>&1; then
    # macOS/BSD
    YESTERDAY=$(date -v-1d +%Y-%m-%d)
    T2DAYS=$(date -v-2d +%Y-%m-%d)
else
    # GNU/Linux
    YESTERDAY=$(date -d "yesterday" +%Y-%m-%d)
    T2DAYS=$(date -d "2 days ago" +%Y-%m-%d)
fi
```

#### Line 301: Platform-specific stat
```bash
local file_size=$(stat -f%z "build/web/data.csv" 2>/dev/null || stat -c%s "build/web/data.csv" 2>/dev/null)
```
**Already handled** with fallback, but SC2155 warning: declare and assign separately to avoid masking errors.
**Fix**:
```bash
local file_size
file_size=$(stat -f%z "build/web/data.csv" 2>/dev/null || stat -c%s "build/web/data.csv" 2>/dev/null)
```

### 3.3 Shellcheck Warnings
- **SC2164** (refresh.sh:52): `cd` without error check
- **SC2155** (refresh.sh:251, 301): Declare and assign separately
- **SC1091** (refresh.sh:189): `.venv/bin/activate` not specified (info only, expected)

### 3.4 Invalid Config Files
- **✓ Validated**: `pyproject.toml`, `netlify.toml`, `data/*.json` all parse correctly

### 3.5 Dead Symlinks
- **None found**

### 3.6 Missing Dependencies
- **requirements.txt** vs **pyproject.toml**: Identical (good), but `pyproject.toml` also lists dev deps (`pytest`, `black`, `flake8`)
- **Gap**: No `requests`, `beautifulsoup4`, or `lxml` usage found in codebase (dependencies for non-existent Python code)

---

## 4. Secrets & Misconfigurations

### Findings
✅ **No hardcoded secrets** found in:
- Shell scripts (`.sh`)
- Python files (`.py` – none exist yet)
- JSON config files
- Documentation

✅ **Proper .gitignore** for:
- `.env` files (except `.env.example`)
- `*.log` files
- Virtual environments (`.venv/`)

✅ **Safe examples** in:
- `.env.example` – placeholder values only

### Recommendations
1. **Audit checklist for future code**:
   - No API keys in source code
   - No passwords in scripts
   - No tokens in comments or logs
   - Use environment variables for all secrets

2. **GitHub Actions secrets**:
   - Store `NETLIFY_AUTH_TOKEN` in GitHub Secrets
   - Never log secret values (use `::add-mask::`)

3. **Netlify environment**:
   - Use Netlify's environment variable UI
   - Restrict access to production tokens

4. **Log sanitization**:
   - `scripts/refresh.sh` logs to `logs/refresh_*.log`
   - **Action**: Add log rotation (keep last 10 logs)
   - **Action**: Grep for sensitive patterns before committing logs

---

## 5. Prompt/Script Parity

### Documentation Claims
- **docs/developer-guides/file-structure.md** describes:
  - Cross-platform scripts (Bash + PowerShell)
  - Python CLI with `download`, `update` commands
  - Comprehensive test suite
  - CI/CD workflows

### Reality
- **Only Bash scripts exist**: `refresh.sh`, `run-site.sh`
- **No PowerShell scripts**: `.ps1` files missing
- **No Python code**: `src/py/` directory absent
- **No tests**: `tests/` nearly empty
- **No CI/CD**: `.github/workflows/` missing

### Gap Analysis
| Feature | Documented | Implemented | Priority |
|---------|-----------|-------------|----------|
| Bash scripts | ✓ | ✓ (partial) | – |
| PowerShell scripts | ✓ | ✗ | High |
| Python CLI | ✓ | ✗ | Critical |
| Python ETL | ✓ | ✗ | Critical |
| Tests | ✓ | ✗ | High |
| CI/CD | ✓ | ✗ | Medium |
| Static site | ✓ | ? (untested) | High |

---

## 6. Action Summary (Prioritized)

### Critical (Blocks Functionality)
1. **Implement Python ETL modules**:
   - `src/py/kolko-ni-struva/etl/download_kolkonistruva.py`
   - `src/py/kolko-ni-struva/etl/update_kolko_ni_struva.py`
   - `src/py/kolko-ni-struva/cli.py`

2. **Fix netlify.toml**: Create `scripts/build.sh` or update to use existing script

3. **Fix refresh.sh portability**:
   - Line 52: Add error check to `cd`
   - Lines 200-201: Replace GNU date with Python or add macOS support
   - Line 301: Fix SC2155 warning

### High (Improves Reliability)
4. **Add PowerShell scripts**: `refresh.ps1`, `run-site.ps1`, `build.ps1`
5. **Create test suite**: `tests/test_etl.py`, `tests/test_cli.py`
6. **Add CI/CD workflows**: `.github/workflows/ci.yml`, `deploy.yml`
7. **Standardize shebangs**: Use `#!/usr/bin/env bash` everywhere
8. **Pre-commit hooks**: Add `.pre-commit-config.yaml` for auto-linting

### Medium (Enhances Quality)
9. **API documentation**: Add docstrings, generate with Sphinx/mkdocs
10. **Changelog maintenance**: Document changes in `CHANGELOG.md`
11. **Version tagging**: Tag releases in git
12. **Build artifact docs**: Add `build/web/README.md`

### Low (Nice to Have)
13. **Log rotation**: Keep last 10 refresh logs
14. **Web UI version display**: Show version in footer
15. **Example user guides**: Add usage examples in `docs/user-guides/`

---

## 7. Portability Migration Path

### Phase 1: Core Stability (Week 1)
1. Implement Python CLI with cross-platform date/file handling
2. Refactor `refresh.sh` to call Python CLI
3. Fix shellcheck warnings
4. Create `scripts/build.sh` for Netlify

### Phase 2: Windows Support (Week 2)
1. Create PowerShell wrappers calling Python CLI
2. Test on Windows (GitHub Actions Windows runner)
3. Document Windows setup in README

### Phase 3: Full Parity (Week 3)
1. Add comprehensive tests (Linux, macOS, Windows)
2. CI/CD pipelines for all platforms
3. Update documentation to reflect actual state
4. Tag v0.2.0 release

---

## Acceptance Criteria Met

- [x] **Every area reviewed**: Code (missing), scripts (✓), prompts (.github/, .specify/), configs (✓), docs (✓)
- [x] **logs/ excluded**: Yes
- [x] **data/raw/ sampled**: Yes (empty, no files to sample)
- [x] **Best-practice recommendations**: Section 2 (portability, CI/CD, testing, linting, secrets, docs, versioning)
- [x] **Secrets/Misconfigurations section**: Section 4 (no findings, recommendations included)
- [x] **Concise, action-focused**: ~2–3 screens, bullet points, file paths, 1-line rationales

---

**Analysis Date**: 2025-11-04  
**Methodology**: Automated scans (shellcheck, JSON/TOML validation, permission checks, dead-link checks) + manual structural review  
**Repository State**: Early development, documentation ahead of implementation, no critical security issues
